\documentclass[FM,bw,DP]{tulthesis}

\usepackage[utf8]{inputenc}
\usepackage[czech]{babel}
\usepackage{setspace}
\usepackage[export]{adjustbox}
\usepackage{graphicx}
\usepackage{listings}
\usepackage{xcolor}

\renewcommand{\thetable}{\arabic{table}}
\renewcommand{\thefigure}{\arabic{figure}}

\newcommand{\includeumlgraph}[2]{%
\begin{figure}[h]
	\centering
    \includegraphics[max width=\textwidth]{../img/graphs/#1.pdf}
    \caption{#2}
	\label{uml:#1}
\end{figure}
}

\newcommand{\includeimg}[2]{%
\begin{figure}[h]
	\centering
    \includegraphics[max width=\textwidth]{../img/#1.pdf}
    \caption{#2}
	\label{img:#1}
\end{figure}
}

\renewcommand{\lstlistingname}{Ukázka kódu}

\lstset{ %
  basicstyle=\small\ttfamily,        % the size of the fonts that are used for the code
  belowcaptionskip=1\baselineskip,
  breakatwhitespace=false,         % sets if automatic breaks should only happen at whitespace
  breaklines=true,                 % sets automatic line breaking
  captionpos=b,                    % sets the caption-position to bottom
  escapeinside={\%*}{*)},          % if you want to add LaTeX within your code
  extendedchars=true,              % lets you use non-ASCII characters; for 8-bits encodings only, does not work with UTF-8
  frame=L,	                   % adds a frame around the code
  keepspaces=true,                 % keeps spaces in text, useful for keeping indentation of code (possibly needs columns=flexible)
  numbers=left,                    % where to put the line-numbers; possible values are (none, left, right)
  numbersep=8pt,                   % how far the line-numbers are from the code
  numberstyle=\footnotesize\color{gray}, % the style that is used for the line-numbers
  rulecolor=\color{black},         % if not set, the frame-color may be changed on line-breaks within not-black text (e.g. comments (green here))
  showspaces=false,                % show spaces everywhere adding particular underscores; it overrides 'showstringspaces'
  showstringspaces=false,          % underline spaces within strings only
  showtabs=false,                  % show tabs within strings adding particular underscores
  stepnumber=1,                    % the step between two line-numbers. If it's 1, each line will be numbered
  tabsize=2,	                   % sets default tabsize to 2 spaces
  title=\lstname,                   % show the filename of files included with \lstinputlisting; also try caption instead of title
  xleftmargin=\parindent,
  numberbychapter=false
}

\onehalfspacing

\TULtitle{Editor konfiguračních souborů Flow123d}{Editor for Flow123d configuration files}
\TULprogramme{N2612}{Elektrotechnika a informatika}%
{Electrotechnology and informatics}
\TULbranch{1802T007}{Informační technologie}%
{Information technology}
\TULauthor{Bc. Tomáš Křížek}
\TULsupervisor{doc. Ing. Jiřina Královcová, Ph.D.}  %TODO uvadet vsechny tituly?
\TULyear{2016}

\begin{document}
\ThesisStart{male}

\begin{abstractCZ}
\thispagestyle{empty}
Český abstrakt
\end{abstractCZ}

\vspace{2cm}
\begin{abstractEN}
English abstract
\end{abstractEN}

\clearpage
\begin{acknowledgement}

\end{acknowledgement}

\tableofcontents
\clearpage

\begin{abbrList}
%\textbf{EU} & Evropská unie \\
\end{abbrList}

\chapter*{Úvod}

Existuje celá řada softwarů, která pro zajištění požadované funkce potřebuje správné nastavení, podle kterého pak daný program přizpůsobí svoji činnost. Může se jednat o~počáteční konfiguraci, jako je tomu například u~serverových aplikací nebo e-mailových klientů. Tato konfigurace se zpravidla dále nemění, pokud nedojde k nějakým podstatným změnám.

Oproti tomu existují programy, od kterých se očekává, že budou spouštěny s širokou škálou různých nastavení. U~těchto aplikací se typicky konfigurace předává při spuštění jako jeden ze vstupních parametrů. Činnost těchto programů se pak zásadně liší dle zvolené konfigurace.

Takovou aplikací je například simulátor Flow123d, který se používá pro modelování procesů v horninovém prostředí. Vstupem do této aplikace je výpočetní síť společně se zadání úlohy. Tato úloha je definovaná pomocí konfiguračního souboru, který vytváří uživatel. Po zadání vstupních dat provede simulátor výpočty na dané síti a výsledky uloží do datového souboru, který je výstupem z aplikace.

Software Flow123d podporuje různé typy úloh. Konfigurace jednotlivých úloh vyžaduje odlišné nastavení a může tedy dojít k tomu, že uživatelem zadaná konfigurace je nevalidní -- například kvůli tomu, že definice dané úlohy neobsahuje některé povinné parametry a je tedy neúplná. V souboru může vzniknout i syntaktická chyba, která způsobí, že zadaná data nelze správně interpretovat.

Popis formátu konfiguračních souborů pro Flow123d je poměrně rozsáhlý -- samotná referenční příručka, která ho popisuje, obsahuje několik desítek stran. To klade na uživatele velké nároky. Pokud chce například ověřit, že byly zadány všechny povinné parametry, buď musí mít se softwarem rozsáhlé zkušenosti, nebo musí trávit velké množství času prohledáváním dokumentace. 

Celá situace je dále komplikována tím, že formát konfiguračních souborů se mění s~tím, jak se vyvíjí nové a upřesňují stávající funkcionality softwaru Flow123d. Může dojít k tomu, že některé změny ve formátu konfiguračních souborů nemusí být zpětně kompatibilní. Uživatel tedy potřebuje znovu prostudovat rozsáhlou referenční dokumentaci, aby zjistil, jakým způsobem zadat dříve realizovanou úlohu pro novou verzi Flow123d.

%TODO dozvi se uzivatel o chybe pomoci textoveho rozhrani nebo z vystupnich souboru?
Pokud se stane, že uživatel spustí Flow123d s nevalidní konfigurací, potom během inicializace dojde k chybě, o které se uživatel dozví pomocí textového rozhraní, ve kterém se Flow123d spouští. Jelikož se může jednat o~výpočetně náročné úlohy, které se často pouští na vzdáleném výpočetním clusteru, je tento proces poměrně časově náročný a uživatelsky nepříjemný.

Při vzdáleném spouštění Flow123d se úloha zařadí do fronty na výpočetním clusteru, kde dále čeká na přidělení zdrojů. Ty se přidělují na základě aktuálního vytížení. Buď jsou k dispozici okamžitě, nebo je nutné čekat na dokončení některých předchozích úloh. Může tedy nastat situace, kdy uživatel zařadí úlohu do fronty a poté čeká na výsledky několik hodin nebo dokonce dní, a teprve potom zjistí, že v konfiguračním souboru, který vytvořil, byla chyba. Kvůli nemohlo dojít k inicializaci úlohy a tím pádem ani neproběhla simulace.

Tyto důvody byly hlavní motivací ke vzniku speciálního editoru pro konfigurační soubory Flow123d, který práci s nimi značně zjednoduší a usnadní. Editor zrychlí proces odstranění chyb tím, že je odhalí už v průběhu vytváření nebo upravování konfiguračních souborů. To uživateli umožní chyby odstranit ještě před tím, než předloží konfigurační soubor softwaru Flow123d. Tím dojde ke značné časové úspoře obzvlášť v případech, kdy se výpočetní úloha spouští vzdáleně.

Součástí editoru má být grafické uživatelské rozhraní. Jedním z jeho hlavních přínosů bude zjednodušení přístupu k~dokumentaci. Uživatel bude mít k dispozici tu část dokumentace, která bezprostředně souvisí s právě upravovanou částí konfiguračního souboru. Tato forma nápovědy by měla uživateli poskytnout alternativu k prohledávání rozsáhlé referenční dokumentace.

Dále bude editor umožňovat zobrazit datovou strukturu, která tvoří konfigurační soubor. Kromě toho bude editor poskytovat základní funkce pro práci s~textovými soubory, jako je podpora operací se schránkou, možnost vrátit či opakovat změny, vyhledávání či nahrazení textu a další. Editor má podporovat platformy Windows a Linux.

%TODO zminit strukturu prace - rozcestnik?


\chapter{Analýza}

%TODO nastaveni flow - serializace objektu - binarni vs textovy format

%TODO nekde zminit - jednosmerna konverze, protoze neplati WYSIWYG, nepracuje se s DOM ale primo s textem



\section{Software Flow123d}

Flow123d je software, který slouží k výpočtu proudění v porézním médiu, transportu látek nebo transportu tepla. Jedná se o aplikaci, která je orientována na práci s daty, a vzhledem k tomu neobsahuje žádné grafické uživatelské rozhraní. Uživatel tedy s aplikací pracuje v textovém režimu prostřednictvím terminálu, kde může aplikaci předat vstupní soubory a případně další parametry.

\includeimg{flow123d}{Simulátor Flow123d a pomocný software}

Na obrázku~\ref{img:flow123d} jsou znázorněny vstupy a výstupy simulátoru Flow123d spolu s pomocnými aplikacemi, které uživatelé často používají. Vstupem do simulátoru Flow123d jsou dva soubory. První z těchto souborů popisuje výpočetní síť pomocí seznamu uzlů a elementů. Jedná se o textový soubor ve formátu \texttt{.msh}. Tuto síť generují softwary GMSH nebo SALOME. Druhým vstupním souborem je konfigurační soubor, který popisuje řešenou úlohu. Tento soubor si prozatím uživatelé tvořili sami pomocí obyčejných textových editorů.
%TODO link gmsh, salome? 
%TODO jak uvadet odkazy na webove stranky?

Pro tento konfigurační soubor vzniká v rámci této práce specializovaný editor s označením ModelEditor, který má oproti obyčejnému textovému editoru poskytnout např. validaci zadaných dat, zobrazení kontextové dokumentace nebo automatické doplňování textu. Vytváření a editace konfiguračních souborů se tak uživateli značně zjednoduší. ModelEditor je jednou ze součástí aplikace GeoMop, která obsahuje i další komponenty.

GeoMop má sloužit jako nástroj, který usnadní práci se simulátorem Flow123d. Jeho další komponenty mají za úkol např. zajišťovat vzdálené spouštění Flow123d na výpočetních clusterech. To bude zajišťovat modul JobsScheduler, který sjednotí rozhraní a postup spouštění Flow123d na různých výpočetních clusterech. Další součástí aplikace GeoMop bude modul Analysis, který umožní úlohy parametrizovat a dále je potom provádět pro různé sady hodnot. GeoMop je aktuálně ve vývoji a je možné, že se bude rozšiřovat o další funkce.

Výstupem ze softwaru Flow123d je datový soubor, který obsahuje výsledky simulace. U tohoto souboru si uživatel může vybrat požadovaný formát, podle toho, kterou aplikaci chce použít pro zpracování výsledků. Typicky uživatelé používají buď opět GMSH nebo ParaView. Existuje také celá řada jednoúčelových nástrojů, které si uživatelé často tvoří sami, nebo vznikají v rámci různých projektů.
%TODO link gmsh paraview

\section{Konfigurační soubory}

V současné době (verze Flow123d 1.8.2), se pro specifikaci úlohy používá jeden konfigurační soubor, který obsahuje všechna potřebná data pro definici a inicializaci úlohy. Z pohledu Flow123d je úloha definovaná pomocí konkrétních objektů, které mají nastavené různé atributy na požadované hodnoty. 

Vzhledem k tomu, že úlohy definují lidé, je potřeba určit nějaké společné rozhraní, pomocí kterého budou moci definovat tyto objekty a jejich obsah. Tato definice zároveň musí být strojově čitelná, aby ji simulátor Flow123d mohl zpracovat a nakonfigurovat se podle ní do správného počátečního stavu pro zahájení výpočtu.

Jelikož se pro předávání dat používají soubory, existují v principu dvě možnosti, jak předat tato data. Formát souboru může být buď binární, nebo textový. Vzhledem k tomu, že soubory mají vytvářet lidé, tak by bylo krajně nepraktické, kdyby se použil binární formát souboru.

Textová reprezentace konfiguračních souborů s sebou kromě čitelnosti přináší i další výhody. Oproti binárnímu formátu není závislá na architektuře, jelikož všechna data jsou kódována ve formě textu. Navíc díky tomu, že textový soubor umožňuje kromě přenosu samotných dat i tyto data nějakým způsobem popsat, potom se změny v interní struktuře Flow123d nemusí nutně projevit ve formátu konfiguračních souborů.

\section{Datová struktura}

Použití textového formátu konfiguračních souborů s sebou však přináší otázku, jakým způsobem tato data v textu reprezentovat. Je důležité, aby pomocí vybraného formátu bylo možné inicializovat libovolnou strukturu tříd v C++. Takové třídy obsahují atributy, které mají název (dále označován jako klíč), typ a hodnotu. Ve většině případů platí, že klíč jednoznačně implikuje typ. Potom je tedy dostačující ukládat dvojici klíč a hodnota.

Existují i situace, kdy z názvu atributu nelze jednoznačně určit jeho typ. To je způsobené použitím polymorfismu. Z klíče lze tedy odvodit pouze jakého typu musí být předek. Pokud má tento předek více potomků, pak je nutné vybraný typ explicitně uvést. Tyto situace jsou prozatím zanedbány a jsou popsány samostatně v kapitole X.
%TODO reference na kapitolu s abstract

V konfiguračních souborech je tedy potřeba ukládat dvojice klíč a hodnota. Hodnotou může být buď jednoduchého nebo složeného datového typu. Reprezentace jednoduchých datových typů je většinou triviální a spočívá pouze v převodu hodnoty na textový řetězec, pokud jím není. Povolené jednoduché datové typy v rámci konfiguračních souborů jsou následující:

\begin{itemize}
	\item booleovské hodnoty, %TODO jak se to spravne oznacuje cesky?
	\item celá čísla,
	\item desetinná čísla,
	\item hodnoty výčtového typu (tzv. enum),
	\item řetězce\footnote{Z pohledu konfiguračních souborů se jedná o jednoduchý datový typ, protože je dále nedělitelný.}.
\end{itemize}

Složeným datovým typem z pohledu použitých konfiguračních souborů může být buď homogenní pole, nebo jiný objekt. Tím pádem vzniká hierarchická datová struktura, která může mít teoreticky nekonečný počet vnořených úrovní. V praxi je samozřejmě počet úrovní vždy konečný, ale důležité je, aby použitý formát umožňoval reprezentovat libovolný počet vnoření.

Na obrázku \ref{img:data_tree} je znázorněna hierarchická struktura složeného datového typu \textit{OutputStream}. Pro názornost jsou vynechány některé atributy. Datový typ \textit{OutputStream} obsahuje řetězec \texttt{file}, což je jednoduchý datový typ. Dále obsahuje pole desetinných čísel \texttt{time\_list}, které dále obsahuje konkrétní desetinná čísla. Posledním znázorněným atributem objektu \textit{OutputStream} je format, který obsahuje referenci na objekt typu \textit{vtk}. Objekt tohoto typu pak dále obsahuje atributy \texttt{variant} a \texttt{parallel}, které jsou jednoduchých datových typů.

\includeimg{data_tree}{Příklad složeného datového typu s různými typy atributů}

\section{Formáty pro výměnu dat}

Ve verzi Flow123d 1.8.2 se pro reprezentaci výše popsané datové struktury používá speciální formát CON, který byl navržen vývojáři Flow123d pro účel zápisu konfiguračních souborů. Jedná se o formát, který vychází z JavaScript Object Notation, který je specifikován standardem ECMA-404. Oproti tomuto standardu se liší v několika detailech.
%TODO zkratka JSON
%TODO reference na JSON - http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-404.pdf

Příklad části konfiguračního souboru ve formátu CON je znázorněn v ukázce kódu \ref{lst:con_example}. Jednou z ihned zřejmých odlišností od formátu JSON je použití znaku \uv{\texttt{=}} místo \uv{\texttt{:}} pro oddělení klíče a hodnoty. Dále není nutné psát názvy klíčů do uvozovek. Další odlišnosti a kompletní specifikaci formátu CON lze nalézt v dokumentaci k Flow123d 1.8.2.
%TODO ref dokumentace flow

\begin{lstlisting}[caption={Část konfiguračního souboru ve formátu CON}, label={lst:con_example}]
output = {
  output_stream = {
    file = "./flow_test16.pvd", 
    format = {
      TYPE = "vtk", 
      variant = "ascii"
    }, 
    name = "flow_output_stream"
  }, 
  output_fields = [ "pressure_p0", "pressure_p1", 
                    "velocity_p0" ]
}
\end{lstlisting}

Během používání tohoto formátu se ale jeho odlišnost od JSON projevila jako jeden z nedostatků. Kvůli nekompatibilitě formátu s formátem JSON nelze použít pro zpracování CON formátu standardní knihovny. To však nebylo jediným nedostatkem tohoto formátu. Z pohledu uživatele, který tento soubor často upravuje, je například velice nepříjemné, že musí neustále hlídat správné uzávorkování výrazů. Na základě těchto nedostatků bylo rozhodnuto, že ve verzi Flow123d 2.0 bude použit nějaký standardní formát pro výměnu dat, který se ukáže jako vhodnější.

%TODO cislovani obrazku - postupne nebo podle kapitol?
% Odlisit obrazek vs diagram?

%\begin{center}
%\line(1,0){250}
%\end{center}
%
%Existuje celá řada možností. Pokud by konfigurační soubory byly triviální, dal by se použít například formát INI, který umožňuje jednoduchým způsobem zapisovat kombinace klíč a hodnota. Vzhledem k tomu, že konfigurační data pro Flow123d mohou tvořit složité hierarchické struktury, jsou však INI soubory nedostačující.
%%TODO zkratka INI
%
% Hierarchické datové struktury lze vhodně popsat například pomocí formátu JSON, YAML nebo jazyka XML. 
%
%
%%TODO najit vhodne umisteni - spise na konec, k diskuzi, co pouzit?
%Flow123d v minulosti používal pro konfigurační soubory vlastní formát CON, který je podobný formátu JSON, ale mírně se od něj odlišuje. Díky tomu však nebyl příliš přenositelný, protože se pro jeho čtení nedaly přímo použít klasické knihovny, které umí číst formát JSON. To byl jeden z důvodů, proč došlo k rozhodnutí použít od verze Flow123d 2.0 jiný formát konfiguračních souborů. 
%%TODO zkratka

%TODO moznosti pro serializaci objektu a repr. konf. souboru
% binarni vs textovy format
% XML, DTD, XMLSchema
% JSON, JSON Schema
% YAML
% proc byl zvolen YAML, diskuze ostatnich moznosti

%\section{Formát konfiguračních souborů}
% o co se jedna, jak to vypada (JSON)
% jakym zpusobem popisuje data - hiearchicka stromova struktura
% nastinit autokonverze, abstraktni zaznamy (zminit ze nemaji dedicnost, spise interface)
% serializace dat -> zaznamy, pole, hodnoty ... obrazek stromu?
% vztah a vznik souboru s formatem - zavislost na verzi
% datove typy - scalar, array, record, abstract
% autokonverze + priklady?


%\chapter{Analýza}
%
%
%\section{Konfigurační soubory}
%Priblizeni konfiguracnich souboru a jejich formatu.
%
%Stary format CON a prechod na novy format YAML.
%
%Diskuze XML/YAML(JSON). 
%
%\section{Input Structure Tree}
%Popis formatu datovych souboru.
%
%Definice konkretnich datovych typu.
%
%Specifikovat mozne atributy.
%
%\section{Autokonverze}
%Popsat mozne konverze, uvest do souvislosti s~XML transformacemi?
%
%
%\chapter{Návrh}
%Diagramy pro zpracovani YAML (inspirace SAX vs DOM).
%
%
%
%
%\chapter{Implementace}


\chapter*{Závěr}
V rámci této diplomové práce byl vytvořen editor konfiguračních souborů pro Flow123d. Jedná se o samostatně funkční aplikaci, která je ovšem navržena s ohledem na její použití jako součást softwarového balíku GeoMop, který obsahuje další nástroje, které usnadňují práci uživatelům Flow123d.
%TODO zminovat GeoMop?

Editor uživatelům zjednodušuje vytváření a upravování konfiguračních souborů. Umožňuje ověřit správnost zadané konfigurace pro zvolenou verzi Flow123d a případně uživatele upozornit na detekované chyby. Tato funkce uživateli přináší časovou úsporu a uživatelsky příjemnější rozhraní při odhalování chyb.

Editor dále uživatelům poskytuje kontextovou dokumentaci a našeptávač. Obě tyto funkce přizpůsobují svůj obsah na základě pozice kurzoru v textu, tedy oblasti, kterou uživatel zrovna upravuje. Pro uživatele to představuje značné zjednodušení, jelikož může využít tyto funkce místo prohledávání rozsáhlé dokumentace.

V neposlední řadě editor obsahuje komponentu pro grafické znázornění datové struktury, která poskytuje alternativní pohled na zadaná data, a umožňuje rychlejší orientaci v rozsáhlých konfiguračních souborech. Kromě těchto stěžejních funkcí editor poskytuje i běžné nástroje pro manipulaci s textem, jako jsou například operace se schránkou, možnost vracení provedených změn, vyhledávání a nahrazení nebo změna úrovně odsazení.

%TODO zmenit formulaci
%TODO zminit GPL + odkaz na zdrojove kody
Aplikace je multiplatformní a podporuje systémy Windows (XP nebo novější) a Linux. S ohledem na požadavek multiplatformní aplikace byl pro vývoj použit jazyk Python~3 a grafická knihovna PyQt~5. K aplikaci byly vytvořeny instalační balíčky pro Windows a Debian.

V rámci budoucího vývoje jsou plánovány další dodatečné funkce. Jedná se např. o zlepšení zvýraznění syntaxe, které se by se mohlo přizpůsobit přímo formátu Flow123d. Další možné vylepšení spočívá v rozšíření funkcionality komponenty pro vizualizaci datové struktury. Ta by mohla v budoucnu podporovat kromě zobrazení i editaci dat nebo vylepšené zobrazení speciálních datových typů.



\end{document}
